<html>
  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <title>You can specify chromeDriver's user data directory for electron app's tests</title>
      <meta name="flattr:id" content="en32oj">
      <meta name="description" content="Jan Hovancik, software developer - guitar player - poetry lover">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta property="og:image" content='http://hovancik.net/img/wood-817459_1280.jpg'/>
      <link href='//fonts.googleapis.com/css?family=Tienne:700,400|Poiret+One|Roboto:300,400' rel='stylesheet' type='text/css'>
      <link href="http://hovancik.net/blog/feed.xml" rel="alternate" title="RSS" type="application/rss+xml" />
      <link href="../../../../../css/normalize.css" rel="stylesheet" />
      <link href="../../../../../css/main.css" rel="stylesheet" />
      <link href="../../../../../img/favicon.ico" rel="icon" type="image/ico" />
      <!-- Matomo -->
      <script type="text/javascript">
        var _paq = _paq || [];
        /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);
        (function() {
          var u="//stats.hovancik.net/";
          _paq.push(['setTrackerUrl', u+'piwik.php']);
          _paq.push(['setSiteId', '1']);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
        })();
      </script>
      <!-- End Matomo Code -->
  </head>
  <body>

          <div class="blog">
      <div class="blog__nav">
        <p>
          <a href="/">hovancik.net</a>/<a href="/blog">blog</a>/
        </p>
      </div>
        <article>
    <div>
      <h1>
        <a href="">You can specify chromeDriver's user data directory for electron app's tests</a>
      </h1>
      <p>
        <small>Posted under
          <a href="/blog/tags/electron/">electron</a>
                    <a href="/blog/tags/spectron/">spectron</a>
                    <a href="/blog/tags/chromedriver/">chromeDriver</a>
                    <a href="/blog/tags/tests/">tests</a>
           on
          <time>May 30 2019</time>
        </small>
      </p>
    </div>
    <div class="center">
      &middot;
    </div>
    <div class="article_text">
    <p>When upgrading <a href="https://hovancik.net/stretchly">stretchly</a> to the version 5 of the <a href="https://electronjs.org/">electron</a>, I found myself fighting with failing tests testing the start of the app with specific settings. (Settings are saved as a file on disk, usually in user's data directory, and loaded on app's start.).</p>

<h2 id="electron-v2">Electron v2</h2>

<p><a href="https://railsgirlssummerofcode.org/">RGSoC</a> students working on stretchly that time, wrote this code for the tests:</p>

<pre><code>let Application = require('spectron').Application
let electronPath = require('electron')
const AppSettings = require('../app/utils/settings')

async function modifySettings (key, value) {
  let app

  try {
    app = new Application({
      path: electronPath,
      args: [
        `${__dirname}/../app`
      ]
    })

    await app.start()
  } catch (err) {
    console.log('error starting app:', err)
    throw err
  }

  try {
    app.client.addCommand('getUserDataPath', function () {
      return this.execute(function () {
        // spectron does not have the ability to "get path", so we
        // instruct spectron to get the contents of the electron module
        // and get the location of the settings file directory
        // (https://github.com/electron/spectron/issues/16)
        return require('electron').remote.app.getPath('userData')
      })
    })
  } catch (err) {
    console.log('error stubbing getUserDataPath command:', err)
    throw err
  }

  try {
    const path = await app.client.getUserDataPath()
    const settingsFile = `${path.value}/config.json`
    const settings = new AppSettings(settingsFile)
    settings.set(key, value)
  } catch (err) {
    console.log('error updating settings:', err)
    throw err
  }

  try {
    await app.stop()
  } catch (err) {
    console.log('error stopping application:', err)
    throw err
  }
}

module.exports = {
  modifySettings
}
</code></pre>

<p>What it does is running the app and then setting the settings we want. For example specific key/value before each test:</p>

<pre><code>beforeEach(function () {
  return modifySettings('isFirstRun', false)
})
</code></pre>

<p>This was working fine (as I found out recently), because each test was running from the same location (or better said, the settings file was always in the same location).</p>

<h2 id="electron-v5">Electron v5</h2>

<p>But this not what was happening in electron 5. Each start of the app had different user data path, thus when <code>modifySettings</code> set some value and I run the test, the path was different already. (As each was different start of the app.)</p>

<p>Fortunately, you can specify the location of user data directory, when creating new Application like this:</p>

<pre><code>new Application({
  path: electronPath,
  args: [
    `${__dirname}/../app`
  ],
  chromeDriverArgs: [
    `--user-data-dir=${__dirname}/stretchly-test-tmp`
  ]
})
</code></pre>

<p>And that's exactly what I did.</p>

<p>When creating Application in <code>modifySettings</code> helper and inside of the tests, the same <code>user-data-dir</code> is specified, thus making tests pass again.</p>

<p>I guess it's not the best idea, as running each test from different directory makes sense, but for this use-case I'm fine with it.</p>

    </div>
    <div class="center">
      &middot;
    </div>
    <p class="social">
      Did you enjoy this? Copy-paste the link from the address bar
      to your favourite social network to share. Subscribe
      <a href="//feeds.feedburner.com/JanHovancik">here</a>.
    </p>
    <div class="center">
      &middot;
    </div>
    <div id='disqus_thread'></div>
<script type='text/javascript'>
//<![CDATA[
                  var disqus_shortname = 'hovancik';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script>
<noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a></noscript>
<a href='http://disqus.com' class='dsq-brlink'>comments powered by <span class='logo-disqus'>Disqus</span></a>

    <div class="center">
      &middot;
    </div>
  </article>

    </div>
    <footer>
      <p class="footer__name"><a href="/">Jan Hovancik</a> 2014+</p>
      <p class="footer__desc">
        software developer - guitar player - poetry lover
      </p>
    </footer>
    <div class="center">
      &middot;
    </div>


  </body>
</html>
